深入理解 Elasticsearch（原书第2版）/（美）拉斐尔·酷奇、马雷克·罗戈任斯基 著

——北京：机械工业出版社，2017.5

Mastering Elasticsearch，Second Edition

ISBN 978-7-111-56825-4

互联网时代，信息过载，为便于从海量信息中快速精准的检索内容，搜索引擎 Apache Lucene 脱颖而出。

Elasticsearch 是一款基于 Apache Lucene 的开源搜索引擎产品。开源、分布式、准实时、RESTFul、高容错、可扩展、易于交互、便于二次开发等特点。

##### Apache Lucene 

提供 成熟、高性能、可扩展、轻量级以及强大 的功能。

AL 内核可以创建为单个 Java 库文件，并且不依赖第三方代码，使用它的全文检索功能。

##### 架构

- 文档（doucument）索引与搜索的主要数据载体，它包含一个或多个字段，存放将要写入索引或将从索引搜索出来的数据

- 字段（field）文档的一个片段，它包含字段的名称和字段的内容两个部分。

- 词项（term）搜索时的一个单位，代表了文本中的一个词。

- 词条（token）词项在字段文本中的一次出现，包括词项的文本、开始和结束的偏移以及词条类型。

AL 将写入索引的所有信息组织为倒排索引（inverted index）的结构形式，它是一种将词项映射到文档的数据结构。

每个索引由多个段（segment）组成，每个段写入一次但是查询多次。索引期间，一个段创建以后不再修改。例如，文档被删除以后，删除信息单独保存在一个文件中，而段本身并没有修改。

通过减少段数量，用于提高的搜索速度，多个段可以 强制 或者 由 AL 内在机制决定某个时刻 执行 段合并（segment merge），用于清理不再使用的信息，因此合并后段数量变少同时每个段体积更大，但此过程非常耗费I/O。建议不要强制进行段合并，合理配置合并策略，交由 AL 自行完成。

norm 是一种与每个被索引文档相关的因子，它存储文档的归一化结果，被用于计算查询相关得分，基于索引时的文档加权值（boost）计算得出，与文档一起被索引存储。使用 norm 可以让 AL 在建立索引时考虑不同文档的权重，不过需要额外的磁盘空间和内存来存储它。

词项向量（term vector）是一种针对每个文档的微型倒排索引。

倒排项中可以存储字段、词项、文档、词项位置和偏移以及荷载（payload）。针对不同的使用目的，AL提供了不同的倒排项格式。

doc values 存储字段的正排索引。

文档中的数据转换为倒排索引、查询串转换为可用于搜索的词项的过程被称为分析（analysis）。

文本分析由分析器来执行，它建立在分词器（tokenizer）、过滤器（filter）及字符映射器（character mapper）之上。

在调用分词器之前使用字符映射器进行文本预处理操作，譬如HTML文本的去标签处理。

AL 的分词器将文本切割成词条，词条是携带各种额外信息的词项，它包含词项在原始文本中的位置，词项的长度。

分词器的工作结果被称为词条流，这些词条将被一个接一个推送给过滤器处理，过滤器用于移除、修改词条流中的词条或者创造新的词条。

索引时，不同的字段可以使用不同的分析器。

检索时，查询串将会使用指定的查询分析器（query parser）进行分析。

索引期和检索期的文本分析要采用同样的分析器，只有查询（query）分词出来的词项与索引中的词项能匹配上才会返回预期的文档集。



AND、OR、NOT

+、-
